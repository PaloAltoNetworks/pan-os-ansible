name: (sub) Discover Python version

defaults:
  run:
    shell: bash

permissions:
  contents: read

on:
  workflow_call:
    outputs:
      pyversion:
        description: A discovered Python version
        value: ${{ jobs.pyversion.outputs.pyversion }}

jobs:
  pyversion:
    name: Discover minimum Python version
    runs-on: ubuntu-latest
    outputs:
      pyversion: ${{ steps.pyversion.outputs.pyversion }}
    steps:
      - name: checkout code
        uses: actions/checkout@v4

      - name: extract Python version
        id: pyversion
        run: |
          # try to extract the 'python = "xxx"' string from TOML file
          CONSTRAINT=$(grep -E '^python\s*=' pyproject.toml | cut -d= -f2- | tr -d ' "')

          if [[ $CONSTRAINT =~ (>=|\^|~)([0-9]+\.[0-9]+) ]]; then
              # echo "Operator: ${BASH_REMATCH[1]}"
              echo "pyver=${BASH_REMATCH[2]}" >> $GITHUB_OUTPUT
          else
              echo "No valid Python version found."
              return 1
          fi
