name: CI

on:
  push:
    branches:
  pull_request:
  #schedule:
  #  - cron: '0 6 * * *'

env:
  NAMESPACE: paloaltonetworks
  COLLECTION_NAME: panos
  PYTHON_VERSION: 3.8

jobs:

  ## Sanity is required:
  #
  # https://docs.ansible.com/ansible/latest/dev_guide/testing_sanity.html
  sanity:
    name: Sanity (â’¶${{ matrix.ansible }})
    strategy:
      matrix:
        ansible:
          #- stable-2.9
          ##- stable-2.10
          #- stable-2.11
          ##- stable-2.12
          ##- devel
          - "2.9"
          - "2.10"
          - "2.11"
          - "2.12"
        include:
          - sanity: "new-sanity"
          - ansible: "2.9"
            sanity: "old-sanity"
          - ansible: "2.10"
            sanity: "old-sanity"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./ansible_collections/${{ env.NAMESPACE }}/${{ env.COLLECTION_NAME }}
    steps:
      - uses: actions/checkout@v3
        with:
          path: ./ansible_collections/${{ env.NAMESPACE }}/${{ env.COLLECTION_NAME }}

      - name: Setup Python
        uses: actions/setup-python@v3
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        uses: Gr1N/setup-poetry@v7
        #with:
        #  poetry-version: 1.0.10

      # Install the head of the given branch (devel, stable-2.10)
      - name: Install ansible-base (${{ matrix.ansible }})
        run: poetry run pip install https://github.com/ansible/ansible/archive/stable-${{ matrix.ansible }}.tar.gz --disable-pip-version-check

      - name: Create lock file
        run: poetry lock

      #- name: Get poetry cache directory
      #  id: poetry-cache
      #  run: echo "::set-output name=dir::$(poetry config cache-dir)"

      #- name: Cache poetry dependencies
      #  uses: actions/cache@v2
      #  with:
      #    #path: ~/.cache/pypoetry/virtualenvs
      #    #key: ${{ runner.os }}-poetry-${{ hashFiles('poetry.lock') }}
      #    ##restore-keys: |
      #    ##  ${{ runner.os }}-poetry-${{ matrix.python-version }}-
      #    path: ${{ steps.poetry-cache.outputs.dir }}
      #    key: ${{ runner.os }}-poetry-${{ hashFiles('**/poetry.lock') }}
      #    restore-keys: |
      #      ${{ runner.os }}-poetry-

      - name: Install dependencies
        run: poetry install

      #- name: Check if pycodestyle exists
      #  continue-on-error: true
      #  run: poetry run which pycodestyle

      #- name: Second pycodestyle check
      #  continue-on-error: true
      #  run: poetry run python -m pycodestyle --max-line-length 160 --config /dev/null --ignore E402,E741,W503,W504 plugins/module_utils/panos.py

      #- name: Test with pytest
      #  run: poetry run make sanity

      - name: Run sanity tests
        timeout-minutes: 8
        run: poetry run make ${{ matrix.sanity }}

      #- name: Run old sanity tests
      #  if: ${{ matrix.ansible == '2.9' || matrix.ansible == '2.10' }}
      #  timeout-minutes: 8
      #  run: poetry run ansible-test sanity -v --skip-test pylint --skip-test rstcheck --python ${{ env.PYTHON_VERSION }}

      #- name: Run current sanity tests
      #  if: ${{ matrix.ansible != '2.9' && matrix.ansible != '2.10' }}
      #  timeout-minutes: 8
      #  run: poetry run ansible-test sanity -v --skip-test pylint --python ${{ env.PYTHON_VERSION }}

      #- name: Run sanity tests
      #  timeout-minutes: 8
      #  #run: poetry run ansible-test sanity -v --skip-test pylint --skip-test rstcheck --skip-test import --python ${{ env.PYTHON_VERSION }}
      #  run: poetry run ansible-test sanity -v --skip-test import --python ${{ env.PYTHON_VERSION }}

  format:
    name: Code Format Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./ansible_collections/${{ env.NAMESPACE }}/${{ env.COLLECTION_NAME }}
    steps:
      - uses: actions/checkout@v3
        with:
          path: ./ansible_collections/${{ env.NAMESPACE }}/${{ env.COLLECTION_NAME }}

      - name: Setup Python
        uses: actions/setup-python@v3
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        uses: Gr1N/setup-poetry@v7

      - name: Create lock file
        run: poetry lock

      - name: Install dependencies
        run: poetry install

      - name: Do black code format check
        run: poetry run black --check --diff .

  test:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./ansible_collections/paloaltonetworks/panos

    steps:
      - uses: actions/checkout@v3
        with:
          path: ./ansible_collections/paloaltonetworks/panos

      - name: Set up Python 3.7
        uses: actions/setup-python@v3
        with:
          python-version: 3.7

      - name: Install pipenv
        run: |
          pip install pipenv

      # - name: Check pipenv cache
      #   id: cache-pipenv
      #   uses: actions/cache@v2
      #   with:
      #     path: ~/.local/share/virtualenvs
      #     key: ${{ runner.os }}-pipenv-${{ hashFiles('**/Pipfile.lock') }}
      #     restore-keys: |
      #       ${{ runner.os }}-pipenv-

      - name: Install dependencies
        # if: steps.cache-pipenv.outputs.cache-hit != 'true'
        run: |
          pipenv install --dev

      - name: Check format
        run: |
          pipenv run make check-format

      - name: ansible-test sanity
        run: |
          pipenv run ansible-test sanity --python 3.7

      - name: ansible-galaxy collection build
        run: |
          pipenv run make build

  release:
    name: release
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [test]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Galaxy auth
        run: |
          mkdir -p ~/.ansible
          echo "token: $GALAXY_API_KEY" > ~/.ansible/galaxy_token
        env:
          GALAXY_API_KEY: ${{ secrets.GALAXY_API_KEY }}
        shell: bash

      - name: Create release and publish
        id: release
        uses: cycjimmy/semantic-release-action@v2
        with:
          semantic_version: 17.1.1
          extra_plugins: |
            conventional-changelog-conventionalcommits@^4.4.0
            @semantic-release/git@^9.0.0
            @semantic-release/exec@^5.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Store built collection
        uses: actions/upload-artifact@v2
        with:
          name: collection
          path: |
            *.tar.gz

  docs:
    name: docs
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [test]
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./ansible_collections/paloaltonetworks/panos

    steps:
      # Just a note here:  The Ansible stuff is apparently doing realpath
      # checks, so trying to simlink stuff and then run Ansible commends
      # such as ansible-test in the symlink directory fails.  Thus we need
      # to have the real path contain ansible_collections/paloaltonetworks/panos.
      - name: Checkout
        uses: actions/checkout@v3
        with:
          path: ./ansible_collections/paloaltonetworks/panos

      - name: Set up Python 3.7
        uses: actions/setup-python@v3
        with:
          python-version: 3.7

      - name: Install pipenv
        run: |
          pip install pipenv

      # - name: Check pipenv cache
      #   id: cache-pipenv
      #   uses: actions/cache@v2
      #   with:
      #     path: ~/.local/share/virtualenvs
      #     key: ${{ runner.os }}-pipenv-${{ hashFiles('**/Pipfile.lock') }}
      #     restore-keys: |
      #       ${{ runner.os }}-pipenv-

      - name: Install dependencies
        # if: steps.cache-pipenv.outputs.cache-hit != 'true'
        run: |
          pipenv install --dev

      - name: Build the collection
        run:
          ansible-galaxy collection build

      # - name: Download built collection
      #   uses: actions/download-artifact@v2
      #   with:
      #     name: collection

      - name: Install built collection
        run:
          ansible-galaxy collection install *.tar.gz

      - name: Generate documentation
        run: |
          pipenv run make docs

      # This is here for right now because the action to deploy seems to assume
      # (and not have a configuration option to) mirror the actions/checkout@v3
      # the with.path spec.
      - name: Move the repo to where the deploy action is looking for it
        run: |
          cd ../../../..
          mv pan-os-ansible the_repo
          mv the_repo/ansible_collections/paloaltonetworks/panos pan-os-ansible
          mkdir -p pan-os-ansible/ansible_collections/paloaltonetworks/panos

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4.2.5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: gh-pages
          folder: docs/html
          clean: true
